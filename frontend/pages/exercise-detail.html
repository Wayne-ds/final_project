<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å‹•ä½œè©³æƒ… - FitMotion</title>
  <link rel="stylesheet" href="../css/style.css">
</head>
<body>
  <!-- å°èˆªåˆ— -->
  <nav class="navbar">
    <div class="container">
      <a href="../index.html" class="navbar-brand">ğŸ’ª FitMotion</a>
      <ul class="navbar-nav">
        <li><a href="../index.html" class="nav-link">é¦–é </a></li>
        <li><a href="exercise-library.html" class="nav-link active">å‹•ä½œè³‡æ–™åº«</a></li>
        <li><a href="workout-plan.html" class="nav-link">è¨“ç·´è¨ˆç•«</a></li>
        <li><a href="training-log.html" class="nav-link">è¨“ç·´è¨˜éŒ„</a></li>
        <li><a href="statistics.html" class="nav-link">çµ±è¨ˆåˆ†æ</a></li>
      </ul>
    </div>
  </nav>

  <!-- ä¸»è¦å…§å®¹ -->
  <main class="main-content">
    <div class="container">
      <!-- è¿”å›æŒ‰éˆ• -->
      <a href="exercise-library.html" class="btn btn-outline mb-3">â† è¿”å›å‹•ä½œè³‡æ–™åº«</a>

      <!-- è¼‰å…¥ä¸­ -->
      <div id="loading" class="text-center" style="padding: 3rem;">
        <div class="loading" style="margin: 0 auto;"></div>
        <p style="margin-top: 1rem; color: #666;">è¼‰å…¥ä¸­...</p>
      </div>

      <!-- å‹•ä½œè©³æƒ…å…§å®¹ -->
      <div id="exercise-detail" class="hidden">
        <!-- å‹•ä½œæ¨™é¡Œ -->
        <div class="card mb-3">
          <h1 id="exercise-name" class="mb-2">-</h1>
          <div id="exercise-tags">
            <!-- å‹•æ…‹ç”Ÿæˆæ¨™ç±¤ -->
          </div>
        </div>

        <div class="grid grid-2">
          <!-- å·¦å´ï¼šå½±ç‰‡èˆ‡åœ–ç‰‡ -->
          <div>
            <!-- YouTube å½±ç‰‡ -->
            <div class="card mb-3">
              <div class="card-header">ğŸ¬ æ•™å­¸å½±ç‰‡</div>
              <div class="card-body" style="padding: 0;">
                <div id="video-container" style="position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden;">
                  <!-- å‹•æ…‹åµŒå…¥ YouTube -->
                </div>
              </div>
            </div>

            <!-- å‹•ä½œæç¤º -->
            <div class="card">
              <div class="card-header">ğŸ’¡ æ³¨æ„äº‹é …</div>
              <div class="card-body">
                <ul id="tips-list" style="margin: 0; padding-left: 1.5rem;">
                  <!-- å‹•æ…‹ç”Ÿæˆ -->
                </ul>
              </div>
            </div>
          </div>

          <!-- å³å´ï¼šèªªæ˜èˆ‡æ“ä½œ -->
          <div>
            <!-- å‹•ä½œæ­¥é©Ÿ -->
            <div class="card mb-3">
              <div class="card-header">ğŸ“‹ å‹•ä½œæ­¥é©Ÿ</div>
              <div class="card-body">
                <ol id="instructions-list" style="margin: 0; padding-left: 1.5rem;">
                  <!-- å‹•æ…‹ç”Ÿæˆ -->
                </ol>
              </div>
            </div>

            <!-- å¿«é€Ÿæ“ä½œ -->
            <div class="card">
              <div class="card-header">âš¡ å¿«é€Ÿæ“ä½œ</div>
              <div class="card-body">
                <button id="add-to-plan-btn" class="btn btn-primary" style="width: 100%; margin-bottom: 0.5rem;">
                  â• åŠ å…¥è¨“ç·´è¨ˆç•«
                </button>
                <button id="start-log-btn" class="btn btn-secondary" style="width: 100%;">
                  ğŸ“ é–‹å§‹è¨˜éŒ„è¨“ç·´
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <script src="../js/api.js"></script> 
<script src="../js/auth-api.js"></script>
  <script>
    let currentExercise = null;

    // é é¢è¼‰å…¥å®Œæˆå¾ŒåŸ·è¡Œ
    document.addEventListener('DOMContentLoaded', async () => {
      const urlParams = new URLSearchParams(window.location.search);
      const exerciseId = urlParams.get('id');
      
      if (!exerciseId) {
        alert('æ‰¾ä¸åˆ°å‹•ä½œ IDï¼');
        window.location.href = 'exercise-library.html';
        return;
      }
      
      await loadExerciseDetail(exerciseId);
    });

    // è¼‰å…¥å‹•ä½œè©³æƒ…
    async function loadExerciseDetail(exerciseId) {
      try {
        currentExercise = await fetchExerciseById(exerciseId);
        
        if (!currentExercise) {
          alert('æ‰¾ä¸åˆ°è©²å‹•ä½œï¼');
          window.location.href = 'exercise-library.html';
          return;
        }
        
        renderExerciseDetail(currentExercise);
        
        // éš±è—è¼‰å…¥ä¸­ï¼Œé¡¯ç¤ºå…§å®¹
        document.getElementById('loading').classList.add('hidden');
        document.getElementById('exercise-detail').classList.remove('hidden');
        
      } catch (error) {
        console.error('è¼‰å…¥å¤±æ•—:', error);
        alert('è¼‰å…¥å‹•ä½œè©³æƒ…å¤±æ•—ï¼');
        window.location.href = 'exercise-library.html';
      }
    }

    // æ¸²æŸ“å‹•ä½œè©³æƒ…
    function renderExerciseDetail(exercise) {
      // æ¨™é¡Œ
      document.getElementById('exercise-name').textContent = exercise.name;
      document.title = `${exercise.name} - FitMotion`;
      
      // æ¨™ç±¤
      const tagsContainer = document.getElementById('exercise-tags');
      tagsContainer.innerHTML = `
        <span class="tag tag-primary">${exercise.targetMuscle}</span>
        <span class="tag tag-warning">${exercise.difficulty}</span>
        <span class="tag tag-info">${exercise.equipment}</span>
      `;
      
      // YouTube å½±ç‰‡
      if (exercise.videoUrl) {
        const videoId = extractYouTubeId(exercise.videoUrl);
        if (videoId) {
          document.getElementById('video-container').innerHTML = `
            <iframe 
              style="position: absolute; top: 0; left: 0; width: 100%; height: 100%;"
              src="https://www.youtube.com/embed/${videoId}" 
              frameborder="0" 
              allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
              allowfullscreen>
            </iframe>
          `;
        }
      } else {
        document.getElementById('video-container').innerHTML = `
          <div style="padding: 3rem; text-align: center; color: #999;">
            <p>æš«ç„¡æ•™å­¸å½±ç‰‡</p>
          </div>
        `;
      }
      
      // å‹•ä½œæ­¥é©Ÿ
      const instructionsList = document.getElementById('instructions-list');
      if (exercise.instructions && exercise.instructions.length > 0) {
        instructionsList.innerHTML = exercise.instructions
          .map(instruction => `<li style="margin-bottom: 0.5rem;">${instruction}</li>`)
          .join('');
      } else {
        instructionsList.innerHTML = '<li>æš«ç„¡è©³ç´°æ­¥é©Ÿ</li>';
      }
      
      // æ³¨æ„äº‹é …
      const tipsList = document.getElementById('tips-list');
      if (exercise.tips && exercise.tips.length > 0) {
        tipsList.innerHTML = exercise.tips
          .map(tip => `<li style="margin-bottom: 0.5rem;">${tip}</li>`)
          .join('');
      } else {
        tipsList.innerHTML = '<li>æš«ç„¡æ³¨æ„äº‹é …</li>';
      }
      
      // è¨­å®šæŒ‰éˆ•äº‹ä»¶
      setupButtons(exercise);
    }

    // å¾ YouTube URL æå– video ID
    function extractYouTubeId(url) {
      const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=)([^#\&\?]*).*/;
      const match = url.match(regExp);
      return (match && match[2].length === 11) ? match[2] : null;
    }

    // è¨­å®šæŒ‰éˆ•åŠŸèƒ½
    function setupButtons(exercise) {
      // åŠ å…¥è¨“ç·´è¨ˆç•«æŒ‰éˆ•
      document.getElementById('add-to-plan-btn').addEventListener('click', async () => {
        const day = prompt('è«‹è¼¸å…¥è¦åŠ å…¥çš„æ—¥æœŸ (monday/tuesday/wednesday/thursday/friday/saturday/sunday):', 'monday');
        
        if (!day) return;
        
        const validDays = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'];
        if (!validDays.includes(day.toLowerCase())) {
          alert('ç„¡æ•ˆçš„æ—¥æœŸï¼è«‹è¼¸å…¥è‹±æ–‡æ˜ŸæœŸï¼ˆå¦‚ï¼šmondayï¼‰');
          return;
        }
        
        const result = await addExerciseToPlan(exercise._id, day.toLowerCase());
        
        if (result) {
          const goToPlan = confirm(`${exercise.name} å·²åŠ å…¥è¨ˆç•«ï¼è¦å‰å¾€æŸ¥çœ‹å—ï¼Ÿ`);
          if (goToPlan) {
            window.location.href = 'workout-plan.html';
          }
        }
      });
      
      // é–‹å§‹è¨˜éŒ„è¨“ç·´æŒ‰éˆ•
      document.getElementById('start-log-btn').addEventListener('click', () => {
        window.location.href = `training-log.html?exerciseId=${exercise._id}`;
      });
    }
  </script>

  <style>
    #exercise-detail.hidden {
      display: none;
    }
    
    #loading.hidden {
      display: none;
    }
  </style>
</body>
</html>