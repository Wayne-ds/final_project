<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>è¨“ç·´è¨ˆç•« - FitMotion</title>
  <link rel="stylesheet" href="../css/style.css">
</head>
<body>
  <nav class="navbar">
    <div class="container">
      <a href="../index.html" class="navbar-brand">ğŸ’ª FitMotion</a>
      <ul class="navbar-nav">
        <li><a href="../index.html" class="nav-link">é¦–é </a></li>
        <li><a href="exercise-library.html" class="nav-link">å‹•ä½œè³‡æ–™åº«</a></li>
        <li><a href="workout-plan.html" class="nav-link active">è¨“ç·´è¨ˆç•«</a></li>
        <li><a href="training-log.html" class="nav-link">è¨“ç·´è¨˜éŒ„</a></li>
        <li><a href="statistics.html" class="nav-link">çµ±è¨ˆåˆ†æ</a></li>
      </ul>
    </div>
  </nav>

  <main class="main-content">
    <div class="container">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
        <h1>ğŸ“‹ æˆ‘çš„è¨“ç·´è¨ˆç•«</h1>
        <a href="plan-editor.html" class="btn btn-primary">âœï¸ ç·¨è¼¯è¨ˆç•«</a>
      </div>

      <div id="loading" class="text-center" style="padding: 3rem;">
        <div class="loading" style="margin: 0 auto;"></div>
        <p style="margin-top: 1rem; color: #666;">è¼‰å…¥ä¸­...</p>
      </div>

      <div id="weekly-plan" class="hidden">
        <div class="card mb-3">
          <div class="card-header" style="background-color: #4ECDC4; color: white; display: flex; justify-content: space-between; align-items: center;">
            <span>ğŸ“… æ˜ŸæœŸä¸€ (Monday)</span>
            <span id="monday-count" class="tag" style="background: white; color: #4ECDC4;">0 å€‹å‹•ä½œ</span>
          </div>
          <div class="card-body">
            <div id="monday-exercises" class="exercises-list"></div>
          </div>
        </div>

        <div class="card mb-3">
          <div class="card-header" style="background-color: #FF6B6B; color: white; display: flex; justify-content: space-between; align-items: center;">
            <span>ğŸ“… æ˜ŸæœŸäºŒ (Tuesday)</span>
            <span id="tuesday-count" class="tag" style="background: white; color: #FF6B6B;">0 å€‹å‹•ä½œ</span>
          </div>
          <div class="card-body">
            <div id="tuesday-exercises" class="exercises-list"></div>
          </div>
        </div>

        <div class="card mb-3">
          <div class="card-header" style="background-color: #45B7D1; color: white; display: flex; justify-content: space-between; align-items: center;">
            <span>ğŸ“… æ˜ŸæœŸä¸‰ (Wednesday)</span>
            <span id="wednesday-count" class="tag" style="background: white; color: #45B7D1;">0 å€‹å‹•ä½œ</span>
          </div>
          <div class="card-body">
            <div id="wednesday-exercises" class="exercises-list"></div>
          </div>
        </div>

        <div class="card mb-3">
          <div class="card-header" style="background-color: #FFA07A; color: white; display: flex; justify-content: space-between; align-items: center;">
            <span>ğŸ“… æ˜ŸæœŸå›› (Thursday)</span>
            <span id="thursday-count" class="tag" style="background: white; color: #FFA07A;">0 å€‹å‹•ä½œ</span>
          </div>
          <div class="card-body">
            <div id="thursday-exercises" class="exercises-list"></div>
          </div>
        </div>

        <div class="card mb-3">
          <div class="card-header" style="background-color: #98D8C8; color: white; display: flex; justify-content: space-between; align-items: center;">
            <span>ğŸ“… æ˜ŸæœŸäº” (Friday)</span>
            <span id="friday-count" class="tag" style="background: white; color: #98D8C8;">0 å€‹å‹•ä½œ</span>
          </div>
          <div class="card-body">
            <div id="friday-exercises" class="exercises-list"></div>
          </div>
        </div>

        <div class="card mb-3">
          <div class="card-header" style="background-color: #F7DC6F; color: white; display: flex; justify-content: space-between; align-items: center;">
            <span>ğŸ“… æ˜ŸæœŸå…­ (Saturday)</span>
            <span id="saturday-count" class="tag" style="background: white; color: #F7DC6F;">0 å€‹å‹•ä½œ</span>
          </div>
          <div class="card-body">
            <div id="saturday-exercises" class="exercises-list"></div>
          </div>
        </div>

        <div class="card mb-3">
          <div class="card-header" style="background-color: #BB8FCE; color: white; display: flex; justify-content: space-between; align-items: center;">
            <span>ğŸ“… æ˜ŸæœŸæ—¥ (Sunday)</span>
            <span id="sunday-count" class="tag" style="background: white; color: #BB8FCE;">0 å€‹å‹•ä½œ</span>
          </div>
          <div class="card-body">
            <div id="sunday-exercises" class="exercises-list"></div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <script src="../js/api.js"></script>
  <script src="../js/auth-api.js"></script>
  <script>
    const days = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'];
    const dayNames = {
      monday: 'æ˜ŸæœŸä¸€',
      tuesday: 'æ˜ŸæœŸäºŒ',
      wednesday: 'æ˜ŸæœŸä¸‰',
      thursday: 'æ˜ŸæœŸå››',
      friday: 'æ˜ŸæœŸäº”',
      saturday: 'æ˜ŸæœŸå…­',
      sunday: 'æ˜ŸæœŸæ—¥'
    };

    document.addEventListener('DOMContentLoaded', async () => {
      // ğŸ†• æª¢æŸ¥ç™»å…¥ç‹€æ…‹
      const isAuth = await requireAuth();
      if (!isAuth) return;
      
      // ğŸ†• æ›´æ–°å°èˆªåˆ—
      updateNavbarUser();
      
      await loadWeeklyPlan();
    });

    async function loadWeeklyPlan() {
      try {
        const plan = await fetchWeeklyPlan();
        
        if (!plan) {
          document.getElementById('loading').innerHTML = 
            '<p style="color: #dc3545;">è¼‰å…¥è¨ˆç•«å¤±æ•—ï¼Œè«‹é‡æ–°æ•´ç†é é¢</p>';
          return;
        }
        
        renderWeeklyPlan(plan);
        
        document.getElementById('loading').classList.add('hidden');
        document.getElementById('weekly-plan').classList.remove('hidden');
        
      } catch (error) {
        console.error('è¼‰å…¥è¨ˆç•«å¤±æ•—:', error);
        document.getElementById('loading').innerHTML = 
          '<p style="color: #dc3545;">è¼‰å…¥å¤±æ•—ï¼Œè«‹é‡æ–°æ•´ç†é é¢</p>';
      }
    }

    function renderWeeklyPlan(plan) {
      days.forEach(day => {
        const exercises = plan.weeklyPlan[day] || [];
        const container = document.getElementById(`${day}-exercises`);
        const countElement = document.getElementById(`${day}-count`);
        
        countElement.textContent = `${exercises.length} å€‹å‹•ä½œ`;
        
        if (exercises.length === 0) {
          container.innerHTML = `
            <p class="text-center" style="color: #999; padding: 2rem;">
              é‚„æ²’æœ‰å®‰æ’å‹•ä½œ<br>
              <a href="exercise-library.html" style="color: var(--primary-color);">å‰å¾€å‹•ä½œè³‡æ–™åº«</a>
            </p>
          `;
          return;
        }
        
        container.innerHTML = '';
        exercises.forEach((item, index) => {
          if (item.exerciseId) {
            const exerciseCard = createExerciseCard(item, day, index);
            container.appendChild(exerciseCard);
          }
        });
      });
    }

    function createExerciseCard(item, day, index) {
      const exercise = item.exerciseId;
      const card = document.createElement('div');
      card.className = 'exercise-item';
      card.style.cssText = `
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 1rem;
        margin-bottom: 0.5rem;
        background: #f8f9fa;
        border-radius: var(--radius-md);
        transition: all 0.3s ease;
      `;
      
      const contentDiv = document.createElement('div');
      contentDiv.style.flex = '1';
      
      const headerDiv = document.createElement('div');
      headerDiv.style.cssText = 'display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;';
      
      const indexSpan = document.createElement('span');
      indexSpan.style.cssText = 'font-weight: bold; color: var(--primary-color);';
      indexSpan.textContent = `#${index + 1}`;
      
      const nameH4 = document.createElement('h4');
      nameH4.style.margin = '0';
      nameH4.textContent = exercise?.name || 'æœªçŸ¥å‹•ä½œ';
      
      headerDiv.appendChild(indexSpan);
      headerDiv.appendChild(nameH4);
      contentDiv.appendChild(headerDiv);
      
      const tagsDiv = document.createElement('div');
      tagsDiv.style.cssText = 'display: flex; gap: 0.5rem; flex-wrap: wrap;';
      tagsDiv.innerHTML = `
        <span class="tag tag-primary">${escapeHtml(exercise.targetMuscle || '')}</span>
        <span class="tag tag-warning">${escapeHtml(exercise.difficulty || '')}</span>
        <span class="tag tag-info">${escapeHtml(exercise.equipment || '')}</span>
        <span class="tag tag-success">${item.sets || 3} çµ„ Ã— ${item.reps || 10} æ¬¡</span>
      `;
      contentDiv.appendChild(tagsDiv);
      
      const actionsDiv = document.createElement('div');
      actionsDiv.style.cssText = 'display: flex; gap: 0.5rem;';
      
      const viewBtn = document.createElement('button');
      viewBtn.className = 'btn btn-outline';
      viewBtn.style.padding = '0.5rem 1rem';
      viewBtn.textContent = 'æŸ¥çœ‹';
      viewBtn.onclick = () => viewExercise(exercise._id);
      
      const removeBtn = document.createElement('button');
      removeBtn.className = 'btn btn-danger';
      removeBtn.style.padding = '0.5rem 1rem';
      removeBtn.textContent = 'ç§»é™¤';
      removeBtn.onclick = () => removeExercise(exercise._id, day);
      
      actionsDiv.appendChild(viewBtn);
      actionsDiv.appendChild(removeBtn);
      
      card.appendChild(contentDiv);
      card.appendChild(actionsDiv);
      
      card.addEventListener('mouseenter', () => {
        card.style.transform = 'translateX(5px)';
        card.style.boxShadow = 'var(--shadow-md)';
      });
      
      card.addEventListener('mouseleave', () => {
        card.style.transform = 'translateX(0)';
        card.style.boxShadow = 'none';
      });
      
      return card;
    }

    function viewExercise(exerciseId) {
      window.location.href = `exercise-detail.html?id=${exerciseId}`;
    }

    async function removeExercise(exerciseId, day) {
      const confirmRemove = confirm(`ç¢ºå®šè¦å¾${dayNames[day]}ç§»é™¤é€™å€‹å‹•ä½œå—ï¼Ÿ`);
      
      if (!confirm(`ç¢ºå®šè¦å¾ ${dayNames[day]} ç§»é™¤é€™å€‹å‹•ä½œå—ï¼Ÿ`)) return;
      
      const result = await removeExerciseFromPlan(exerciseId, day);
      
      if (result) {
        await loadWeeklyPlan();
      }
    }
  </script>

  <style>
    .hidden {
      display: none;
    }

    .exercises-list {
      min-height: 100px;
    }

    .exercise-item {
      animation: fadeIn 0.3s ease;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
  </style>
</body>
</html>