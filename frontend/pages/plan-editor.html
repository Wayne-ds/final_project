<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>è¨ˆç•«ç·¨è¼¯å™¨ - FitMotion</title>
  <link rel="stylesheet" href="../css/style.css">
</head>
<body>
  <!-- å°èˆªåˆ— -->
  <nav class="navbar">
    <div class="container">
      <a href="../index.html" class="navbar-brand">ğŸ’ª FitMotion</a>
      <ul class="navbar-nav">
        <li><a href="../index.html" class="nav-link">é¦–é </a></li>
        <li><a href="exercise-library.html" class="nav-link">å‹•ä½œè³‡æ–™åº«</a></li>
        <li><a href="workout-plan.html" class="nav-link active">è¨“ç·´è¨ˆç•«</a></li>
        <li><a href="training-log.html" class="nav-link">è¨“ç·´è¨˜éŒ„</a></li>
        <li><a href="statistics.html" class="nav-link">çµ±è¨ˆåˆ†æ</a></li>
      </ul>
    </div>
  </nav>

  <!-- ä¸»è¦å…§å®¹ -->
  <main class="main-content">
    <div class="container">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
        <h1>âœï¸ è¨ˆç•«ç·¨è¼¯å™¨</h1>
        <div style="display: flex; gap: 0.5rem;">
          <a href="workout-plan.html" class="btn btn-outline">â† è¿”å›</a>
          <button id="save-plan-btn" class="btn btn-success">ğŸ’¾ å„²å­˜è¨ˆç•«</button>
        </div>
      </div>

      <!-- èªªæ˜ -->
      <div class="card mb-3" style="background: #e3f7f6; border-left: 4px solid var(--primary-color);">
        <p style="margin: 0; color: #2c3e50;">
          ğŸ’¡ <strong>ä½¿ç”¨èªªæ˜ï¼š</strong>å°‡å·¦å´å‹•ä½œå¡ç‰‡æ‹–æ›³åˆ°å³å´å°æ‡‰çš„æ—¥æœŸæ¡†ä¸­ï¼Œå³å¯åŠ å…¥è¨“ç·´è¨ˆç•«
        </p>
      </div>

      <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 1.5rem;">
        <!-- å·¦å´ï¼šå‹•ä½œæ¸…å–® -->
        <div>
          <div class="card">
            <div class="card-header">ğŸ“š å‹•ä½œæ¸…å–®</div>
            <div class="card-body">
              <!-- æœå°‹æ¡† -->
              <input 
                type="text" 
                id="search-exercises" 
                class="form-input mb-2" 
                placeholder="ğŸ” æœå°‹å‹•ä½œ..."
              >
              
              <!-- å‹•ä½œå¡ç‰‡ -->
              <div id="exercise-list" style="max-height: 600px; overflow-y: auto;">
                <!-- å‹•æ…‹ç”Ÿæˆå¯æ‹–æ›³çš„å‹•ä½œå¡ç‰‡ -->
              </div>
            </div>
          </div>
        </div>

        <!-- å³å´ï¼šæ¯é€±è¨ˆç•«ç·¨è¼¯å€ -->
        <div>
          <div id="weekly-editor">
            <!-- é€±ä¸€ -->
            <div class="day-card mb-2">
              <div class="day-header" style="background-color: #4ECDC4;">
                ğŸ“… æ˜ŸæœŸä¸€ (Monday)
              </div>
              <div class="day-dropzone" data-day="monday" id="monday-zone">
                <p class="empty-hint">æ‹–æ›³å‹•ä½œåˆ°é€™è£¡</p>
              </div>
            </div>

            <!-- é€±äºŒ -->
            <div class="day-card mb-2">
              <div class="day-header" style="background-color: #FF6B6B;">
                ğŸ“… æ˜ŸæœŸäºŒ (Tuesday)
              </div>
              <div class="day-dropzone" data-day="tuesday" id="tuesday-zone">
                <p class="empty-hint">æ‹–æ›³å‹•ä½œåˆ°é€™è£¡</p>
              </div>
            </div>

            <!-- é€±ä¸‰ -->
            <div class="day-card mb-2">
              <div class="day-header" style="background-color: #45B7D1;">
                ğŸ“… æ˜ŸæœŸä¸‰ (Wednesday)
              </div>
              <div class="day-dropzone" data-day="wednesday" id="wednesday-zone">
                <p class="empty-hint">æ‹–æ›³å‹•ä½œåˆ°é€™è£¡</p>
              </div>
            </div>

            <!-- é€±å›› -->
            <div class="day-card mb-2">
              <div class="day-header" style="background-color: #FFA07A;">
                ğŸ“… æ˜ŸæœŸå›› (Thursday)
              </div>
              <div class="day-dropzone" data-day="thursday" id="thursday-zone">
                <p class="empty-hint">æ‹–æ›³å‹•ä½œåˆ°é€™è£¡</p>
              </div>
            </div>

            <!-- é€±äº” -->
            <div class="day-card mb-2">
              <div class="day-header" style="background-color: #98D8C8;">
                ğŸ“… æ˜ŸæœŸäº” (Friday)
              </div>
              <div class="day-dropzone" data-day="friday" id="friday-zone">
                <p class="empty-hint">æ‹–æ›³å‹•ä½œåˆ°é€™è£¡</p>
              </div>
            </div>

            <!-- é€±å…­ -->
            <div class="day-card mb-2">
              <div class="day-header" style="background-color: #F7DC6F;">
                ğŸ“… æ˜ŸæœŸå…­ (Saturday)
              </div>
              <div class="day-dropzone" data-day="saturday" id="saturday-zone">
                <p class="empty-hint">æ‹–æ›³å‹•ä½œåˆ°é€™è£¡</p>
              </div>
            </div>

            <!-- é€±æ—¥ -->
            <div class="day-card mb-2">
              <div class="day-header" style="background-color: #BB8FCE;">
                ğŸ“… æ˜ŸæœŸæ—¥ (Sunday)
              </div>
              <div class="day-dropzone" data-day="sunday" id="sunday-zone">
                <p class="empty-hint">æ‹–æ›³å‹•ä½œåˆ°é€™è£¡</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- å¼•å…¥ JavaScript -->
  <script src="../js/api.js"></script>
  <script>
    let allExercises = [];
    let currentPlan = {
      monday: [],
      tuesday: [],
      wednesday: [],
      thursday: [],
      friday: [],
      saturday: [],
      sunday: []
    };

    // é é¢è¼‰å…¥å®Œæˆå¾ŒåŸ·è¡Œ
    document.addEventListener('DOMContentLoaded', async () => {
      await loadExercises();
      await loadCurrentPlan();
      setupDragAndDrop();
      setupSearch();
      setupSaveButton();
    });

    // è¼‰å…¥æ‰€æœ‰å‹•ä½œ
    async function loadExercises() {
      allExercises = await fetchExercises();
      renderExerciseList(allExercises);
    }

    // è¼‰å…¥ç›®å‰è¨ˆç•«
    async function loadCurrentPlan() {
      const plan = await fetchWeeklyPlan();
      if (plan && plan.weeklyPlan) {
        currentPlan = plan.weeklyPlan;
        renderCurrentPlan();
      }
    }

    // æ¸²æŸ“å‹•ä½œæ¸…å–®ï¼ˆå·¦å´å¯æ‹–æ›³ï¼‰
    function renderExerciseList(exercises) {
      const container = document.getElementById('exercise-list');
      container.innerHTML = '';
      
      exercises.forEach(exercise => {
        const card = document.createElement('div');
        card.className = 'draggable-exercise';
        card.draggable = true;
        card.dataset.exerciseId = exercise._id;
        card.dataset.exerciseName = exercise.name;
        
        card.innerHTML = `
          <div style="display: flex; align-items: center; gap: 0.5rem;">
            <div style="font-size: 1.5rem;">â‹®â‹®</div>
            <div style="flex: 1;">
              <div style="font-weight: bold; margin-bottom: 0.25rem;">${exercise.name}</div>
              <div style="display: flex; gap: 0.25rem;">
                <span class="tag tag-primary" style="font-size: 0.75rem;">${exercise.targetMuscle}</span>
                <span class="tag tag-warning" style="font-size: 0.75rem;">${exercise.difficulty}</span>
              </div>
            </div>
          </div>
        `;
        
        container.appendChild(card);
      });
    }

    // æ¸²æŸ“ç›®å‰è¨ˆç•«ï¼ˆå³å´æ”¾ç½®å€ï¼‰
    function renderCurrentPlan() {
      const days = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'];
      
      days.forEach(day => {
        const zone = document.getElementById(`${day}-zone`);
        const exercises = currentPlan[day] || [];
        
        if (exercises.length === 0) {
          zone.innerHTML = '<p class="empty-hint">æ‹–æ›³å‹•ä½œåˆ°é€™è£¡</p>';
        } else {
          zone.innerHTML = '';
          exercises.forEach(item => {
            if (item.exerciseId) {
              const exerciseItem = createPlanItem(item.exerciseId, day);
              zone.appendChild(exerciseItem);
            }
          });
        }
      });
    }

    // å»ºç«‹è¨ˆç•«é …ç›®
    function createPlanItem(exercise, day) {
      const item = document.createElement('div');
      item.className = 'plan-item';
      item.dataset.exerciseId = exercise._id;
      
      item.innerHTML = `
        <div style="flex: 1;">
          <div style="font-weight: bold;">${exercise.name}</div>
          <span class="tag tag-primary" style="font-size: 0.75rem;">${exercise.targetMuscle}</span>
        </div>
        <button class="remove-btn" onclick="removePlanItem('${exercise._id}', '${day}')">Ã—</button>
      `;
      
      return item;
    }

    // è¨­å®šæ‹–æ”¾åŠŸèƒ½ï¼ˆä½¿ç”¨äº‹ä»¶å§”æ´¾ï¼Œåªç¶å®šä¸€æ¬¡ï¼‰
    function setupDragAndDrop() {
      const exerciseList = document.getElementById('exercise-list');
      const dropZones = document.querySelectorAll('.day-dropzone');
      
      // ä½¿ç”¨äº‹ä»¶å§”æ´¾è™•ç†æ‹–æ›³
      exerciseList.addEventListener('dragstart', (e) => {
        if (e.target.classList.contains('draggable-exercise')) {
          e.dataTransfer.effectAllowed = 'copy';
          e.dataTransfer.setData('exerciseId', e.target.dataset.exerciseId);
          e.dataTransfer.setData('exerciseName', e.target.dataset.exerciseName);
          e.target.style.opacity = '0.5';
        }
      });
      
      exerciseList.addEventListener('dragend', (e) => {
        if (e.target.classList.contains('draggable-exercise')) {
          e.target.style.opacity = '1';
        }
      });
      
      // æ”¾ç½®å€åŸŸ
      dropZones.forEach(zone => {
        zone.addEventListener('dragover', (e) => {
          e.preventDefault();
          e.dataTransfer.dropEffect = 'copy';
          zone.classList.add('drag-over');
        });
        
        zone.addEventListener('dragleave', (e) => {
          zone.classList.remove('drag-over');
        });
        
        zone.addEventListener('drop', async (e) => {
          e.preventDefault();
          zone.classList.remove('drag-over');
          
          const exerciseId = e.dataTransfer.getData('exerciseId');
          const exerciseName = e.dataTransfer.getData('exerciseName');
          const day = zone.dataset.day;
          
          // æª¢æŸ¥æ˜¯å¦å·²å­˜åœ¨
          const exists = currentPlan[day].some(item => 
            item.exerciseId && item.exerciseId._id === exerciseId
          );
          
          if (exists) {
            showNotification('è©²å‹•ä½œå·²åœ¨è¨ˆç•«ä¸­', 'warning');
            return;
          }
          
          // åŠ å…¥è¨ˆç•«
          const result = await addExerciseToPlan(exerciseId, day);
          
          if (result) {
            await loadCurrentPlan();
          }
        });
      });
    }

    // è¨­å®šæœå°‹åŠŸèƒ½
    function setupSearch() {
      document.getElementById('search-exercises').addEventListener('input', (e) => {
        const keyword = e.target.value.toLowerCase();
        const filtered = allExercises.filter(ex => 
          ex.name.toLowerCase().includes(keyword)
        );
        renderExerciseList(filtered);
        // ä¸éœ€è¦é‡æ–°è¨­å®šæ‹–æ”¾äº†ï¼Œå› ç‚ºä½¿ç”¨äº‹ä»¶å§”æ´¾
      });
    }

    // ç§»é™¤è¨ˆç•«é …ç›®
    async function removePlanItem(exerciseId, day) {
      const result = await removeExerciseFromPlan(exerciseId, day);
      if (result) {
        await loadCurrentPlan();
      }
    }

    // è¨­å®šå„²å­˜æŒ‰éˆ•
    function setupSaveButton() {
      document.getElementById('save-plan-btn').addEventListener('click', async () => {
        showNotification('è¨ˆç•«å·²è‡ªå‹•å„²å­˜ï¼', 'success');
        
        setTimeout(() => {
          const goToView = confirm('è¦å‰å¾€æŸ¥çœ‹è¨ˆç•«å—ï¼Ÿ');
          if (goToView) {
            window.location.href = 'workout-plan.html';
          }
        }, 500);
      });
    }
  </script>

  <style>
    /* å‹•ä½œå¡ç‰‡ï¼ˆå¯æ‹–æ›³ï¼‰ */
    .draggable-exercise {
      background: white;
      padding: 0.75rem;
      margin-bottom: 0.5rem;
      border-radius: var(--radius-md);
      border: 2px solid var(--border-color);
      cursor: move;
      transition: all 0.3s ease;
    }

    .draggable-exercise:hover {
      border-color: var(--primary-color);
      box-shadow: var(--shadow-md);
      transform: scale(1.02);
    }

    /* æ—¥æœŸå¡ç‰‡ */
    .day-card {
      background: white;
      border-radius: var(--radius-lg);
      overflow: hidden;
      box-shadow: var(--shadow-sm);
    }

    .day-header {
      padding: 0.75rem 1rem;
      color: white;
      font-weight: bold;
    }

    /* æ”¾ç½®å€åŸŸ */
    .day-dropzone {
      min-height: 80px;
      padding: 1rem;
      background: #f8f9fa;
      transition: all 0.3s ease;
    }

    .day-dropzone.drag-over {
      background: #e3f7f6;
      border: 2px dashed var(--primary-color);
    }

    .empty-hint {
      text-align: center;
      color: #999;
      margin: 1rem 0;
      font-size: 0.9rem;
    }

    /* è¨ˆç•«é …ç›® */
    .plan-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.75rem;
      margin-bottom: 0.5rem;
      background: white;
      border-radius: var(--radius-md);
      border: 1px solid var(--border-color);
      animation: slideIn 0.3s ease;
    }

    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateX(-20px);
      }
      to {
        opacity: 1;
        transform: translateX(0);
      }
    }

    .remove-btn {
      background: var(--error-color);
      color: white;
      border: none;
      border-radius: var(--radius-full);
      width: 24px;
      height: 24px;
      cursor: pointer;
      font-size: 1.2rem;
      line-height: 1;
      transition: all 0.3s ease;
    }

    .remove-btn:hover {
      transform: scale(1.1);
      box-shadow: var(--shadow-md);
    }
  </style>
</body>
</html>