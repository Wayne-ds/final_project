<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å‹•ä½œè³‡æ–™åº« - FitMotion</title>
  <link rel="stylesheet" href="../css/style.css">
</head>
<body>
  <nav class="navbar">
    <div class="container">
      <a href="../index.html" class="navbar-brand">ğŸ’ª FitMotion</a>
      <ul class="navbar-nav">
        <li><a href="../index.html" class="nav-link">é¦–é </a></li>
        <li><a href="exercise-library.html" class="nav-link active">å‹•ä½œè³‡æ–™åº«</a></li>
        <li><a href="workout-plan.html" class="nav-link">è¨“ç·´è¨ˆç•«</a></li>
        <li><a href="training-log.html" class="nav-link">è¨“ç·´è¨˜éŒ„</a></li>
        <li><a href="statistics.html" class="nav-link">çµ±è¨ˆåˆ†æ</a></li>
      </ul>
    </div>
  </nav>

  <main class="main-content">
    <div class="container">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
        <h1>ğŸ“š å‹•ä½œè³‡æ–™åº«</h1>
        <a href="custom-exercise.html" class="btn btn-primary">â• æ–°å¢è‡ªè¨‚å‹•ä½œ</a>
      </div>

      <div class="card mb-4">
        <div class="card-body">
          <div class="form-group">
            <input type="text" id="search-input" class="form-input" placeholder="ğŸ” æœå°‹å‹•ä½œåç¨±...">
          </div>

          <div class="grid grid-3">
            <div>
              <label class="form-label">ç›®æ¨™éƒ¨ä½</label>
              <div id="muscle-filters" style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
                <button class="tag tag-primary filter-btn" data-type="muscle" data-value="èƒ¸è‚Œ">èƒ¸è‚Œ</button>
                <button class="tag tag-primary filter-btn" data-type="muscle" data-value="èƒŒè‚Œ">èƒŒè‚Œ</button>
                <button class="tag tag-primary filter-btn" data-type="muscle" data-value="è…¿éƒ¨">è…¿éƒ¨</button>
                <button class="tag tag-primary filter-btn" data-type="muscle" data-value="è‚©è†€">è‚©è†€</button>
                <button class="tag tag-primary filter-btn" data-type="muscle" data-value="æ‰‹è‡‚">æ‰‹è‡‚</button>
                <button class="tag tag-primary filter-btn" data-type="muscle" data-value="æ ¸å¿ƒ">æ ¸å¿ƒ</button>
              </div>
            </div>

            <div>
              <label class="form-label">é›£åº¦ç­‰ç´š</label>
              <div id="difficulty-filters" style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
                <button class="tag tag-success filter-btn" data-type="difficulty" data-value="åˆç´š">åˆç´š</button>
                <button class="tag tag-warning filter-btn" data-type="difficulty" data-value="ä¸­ç´š">ä¸­ç´š</button>
                <button class="tag tag-secondary filter-btn" data-type="difficulty" data-value="é«˜ç´š">é«˜ç´š</button>
              </div>
            </div>

            <div>
              <label class="form-label">ä½¿ç”¨å™¨æ</label>
              <div id="equipment-filters" style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
                <button class="tag tag-info filter-btn" data-type="equipment" data-value="å•éˆ´">å•éˆ´</button>
                <button class="tag tag-info filter-btn" data-type="equipment" data-value="æ§“éˆ´">æ§“éˆ´</button>
                <button class="tag tag-info filter-btn" data-type="equipment" data-value="æ©Ÿæ¢°">æ©Ÿæ¢°</button>
                <button class="tag tag-info filter-btn" data-type="equipment" data-value="å¾’æ‰‹">å¾’æ‰‹</button>
                <button class="tag tag-info filter-btn" data-type="equipment" data-value="å½ˆåŠ›å¸¶">å½ˆåŠ›å¸¶</button>
              </div>
            </div>
          </div>

          <div style="margin-top: 1rem; text-align: center; color: #666;">
            <span id="result-count">æ‰¾åˆ° 0 å€‹å‹•ä½œ</span>
            <button id="clear-filters" class="btn btn-outline" style="margin-left: 1rem;">æ¸…é™¤ç¯©é¸</button>
          </div>
        </div>
      </div>

      <div id="exercises-grid" class="grid grid-3"></div>
    </div>
  </main>

  <script src="../js/api.js"></script>
  <script src="../js/auth-api.js"></script>
  <script>
    let allExercises = [];
    let selectedFilters = { muscle: [], difficulty: [], equipment: [] };

    document.addEventListener('DOMContentLoaded', async () => {
      // ğŸ†• åˆå§‹åŒ–èªè­‰ç‹€æ…‹
      await initAuthState();
      
      await loadExercises();
      setupEventListeners();
    });

    async function loadExercises() {
      allExercises = await fetchExercises();
      renderExercises(allExercises);
    }

    function renderExercises(exercises) {
  const grid = document.getElementById('exercises-grid');
  const countDisplay = document.getElementById('result-count');
  
  if (exercises.length === 0) {
    grid.innerHTML = `<div class="text-center" style="grid-column: 1/-1; padding: 3rem; color: #999;">
                        <div style="font-size: 3rem;">ğŸ˜•</div>
                        <p>æ‰¾ä¸åˆ°ç¬¦åˆæ¢ä»¶çš„å‹•ä½œ</p>
                      </div>`;
    countDisplay.textContent = 'æ‰¾åˆ° 0 å€‹å‹•ä½œ';
    return;
  }

  grid.innerHTML = exercises.map((exercise, index) => {
    // ç¢ºä¿æœ‰ ID å¯ä»¥ç”¨
    const id = exercise._id || index.toString();
    const customBadge = exercise.isCustom ? '<span class="tag tag-success" style="margin-left: 0.5rem;">è‡ªè¨‚</span>' : '';

    return `
      <div class="card" style="cursor: pointer;" onclick="viewDetails('${id}')">
        <img src="${exercise.imageUrl}" alt="${exercise.name}" style="width: 100%; height: 180px; object-fit: cover; border-radius: var(--radius-md); margin-bottom: 1rem;">
        <h3 style="margin-bottom: 0.5rem;">${escapeHtml(exercise.name)}${customBadge}</h3>
        <div style="margin-bottom: 1rem;">
          <span class="tag tag-primary">${escapeHtml(exercise.targetMuscle)}</span>
          <span class="tag tag-warning">${escapeHtml(exercise.difficulty)}</span>
          <span class="tag tag-info">${escapeHtml(exercise.equipment)}</span>
        </div>
        <p style="color: #666; font-size: 0.9rem; margin-bottom: 1rem;">${exercise.instructions[0] || 'æš«ç„¡èªªæ˜'}</p>
        <div style="display: flex; gap: 0.5rem;">
          <button class="btn btn-primary" style="flex: 1;">æŸ¥çœ‹è©³æƒ…</button>
          ${exercise.isCustom 
            ? `<button class="btn btn-danger" onclick="event.stopPropagation(); deleteExercise('${id}', '${exercise.name}')">åˆªé™¤</button>`
            : `<button class="btn btn-outline" onclick="event.stopPropagation(); addToPlan('${id}', '${exercise.name}')">åŠ å…¥è¨ˆç•«</button>`
          }
        </div>
      </div>
    `;
  }).join('');

  countDisplay.textContent = `æ‰¾åˆ° ${exercises.length} å€‹å‹•ä½œ`;
}

    function setupEventListeners() {
      document.getElementById('search-input').addEventListener('input', filterExercises);

      document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const type = btn.dataset.type;
          const value = btn.dataset.value;
          
          btn.classList.toggle('active');
          
          if (btn.classList.contains('active')) {
            if (!selectedFilters[type].includes(value)) {
              selectedFilters[type].push(value);
            }
            btn.style.opacity = '1';
            btn.style.fontWeight = 'bold';
          } else {
            selectedFilters[type] = selectedFilters[type].filter(v => v !== value);
            btn.style.opacity = '0.6';
            btn.style.fontWeight = 'normal';
          }
          
          filterExercises();
        });
      });

      document.getElementById('clear-filters').addEventListener('click', () => {
        selectedFilters = { muscle: [], difficulty: [], equipment: [] };
        
        document.querySelectorAll('.filter-btn').forEach(btn => {
          btn.classList.remove('active');
          btn.style.opacity = '0.6';
          btn.style.fontWeight = 'normal';
        });
        
        document.getElementById('search-input').value = '';
        filterExercises();
      });
    }

    function filterExercises() {
      const keyword = document.getElementById('search-input').value.toLowerCase();
      
      const filtered = allExercises.filter(exercise => {
        const matchKeyword = keyword === '' || exercise.name.toLowerCase().includes(keyword);
        const matchMuscle = selectedFilters.muscle.length === 0 || selectedFilters.muscle.includes(exercise.targetMuscle);
        const matchDifficulty = selectedFilters.difficulty.length === 0 || selectedFilters.difficulty.includes(exercise.difficulty);
        const matchEquipment = selectedFilters.equipment.length === 0 || selectedFilters.equipment.includes(exercise.equipment);
        
        return matchKeyword && matchMuscle && matchDifficulty && matchEquipment;
      });
      
      renderExercises(filtered);
    }

    function viewDetails(exerciseId) {
      window.location.href = `exercise-detail.html?id=${exerciseId}`;
    }

    async function addToPlan(exerciseId, exerciseName) {
      // ğŸ†• æª¢æŸ¥æ˜¯å¦ç™»å…¥
      if (!isLoggedIn()) {
        showNotification('è«‹å…ˆç™»å…¥', 'warning');
        setTimeout(() => {
          window.location.href = 'login.html';
        }, 1000);
        return;
      }
      
      const day = prompt('è«‹è¼¸å…¥è¦åŠ å…¥çš„æ—¥æœŸ (monday/tuesday/wednesday/thursday/friday/saturday/sunday):', 'monday');
      
      if (!day) return;
      
      const validDays = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'];
      if (!validDays.includes(day.toLowerCase())) {
        alert('ç„¡æ•ˆçš„æ—¥æœŸï¼');
        return;
      }
      
      const result = await addExerciseToPlan(exerciseId, day.toLowerCase());
      
      if (result) {
        const goToPlan = confirm(`${exerciseName} å·²åŠ å…¥è¨ˆç•«ï¼è¦å‰å¾€æŸ¥çœ‹å—ï¼Ÿ`);
        if (goToPlan) {
          window.location.href = 'workout-plan.html';
        }
      }
    }

    async function deleteExercise(exerciseId, exerciseName) {
      // ğŸ†• æª¢æŸ¥æ˜¯å¦ç™»å…¥
      if (!isLoggedIn()) {
        showNotification('è«‹å…ˆç™»å…¥', 'warning');
        return;
      }
      
      const confirmDelete = confirm(`ç¢ºå®šè¦åˆªé™¤è‡ªè¨‚å‹•ä½œã€Œ${exerciseName}ã€å—ï¼Ÿ`);
      if (!confirmDelete) return;
      
      const result = await deleteCustomExercise(exerciseId);
      if (result) {
        await loadExercises();
      }
    }
  </script>

  <style>
    .filter-btn {
      cursor: pointer;
      border: none;
      transition: all 0.3s ease;
      opacity: 0.6;
    }

    .filter-btn:hover {
      transform: translateY(-2px);
      opacity: 1;
    }

    .filter-btn.active {
      opacity: 1;
      font-weight: bold;
      box-shadow: var(--shadow-md);
    }
  </style>
</body>
</html>