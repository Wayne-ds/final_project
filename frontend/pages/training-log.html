<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>è¨“ç·´è¨˜éŒ„ - FitMotion</title>
  <link rel="stylesheet" href="../css/style.css">
</head>
<body>
  <nav class="navbar">
    <div class="container">
      <a href="../index.html" class="navbar-brand">ğŸ’ª FitMotion</a>
      <ul class="navbar-nav">
        <li><a href="../index.html" class="nav-link">é¦–é </a></li>
        <li><a href="exercise-library.html" class="nav-link">å‹•ä½œè³‡æ–™åº«</a></li>
        <li><a href="workout-plan.html" class="nav-link">è¨“ç·´è¨ˆç•«</a></li>
        <li><a href="training-log.html" class="nav-link active">è¨“ç·´è¨˜éŒ„</a></li>
        <li><a href="statistics.html" class="nav-link">çµ±è¨ˆåˆ†æ</a></li>
      </ul>
    </div>
  </nav>

  <main class="main-content">
    <div class="container">
      <h1 class="mb-3">ğŸ“ è¨“ç·´è¨˜éŒ„</h1>

      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem;">
        <div>
          <div class="card">
            <div class="card-header">â• æ–°å¢è¨“ç·´è¨˜éŒ„</div>
            <div class="card-body">
              <form id="log-form">
                <div class="form-group">
                  <label class="form-label">é¸æ“‡å‹•ä½œ *</label>
                  <select id="exercise-select" class="form-select" required>
                    <option value="">-- è«‹é¸æ“‡å‹•ä½œ --</option>
                  </select>
                </div>

                <div class="form-group">
                  <label class="form-label">é‡é‡ (kg) *</label>
                  <input type="number" id="weight-input" class="form-input" placeholder="ä¾‹å¦‚ï¼š60" min="0" max="500" step="0.5" required>
                </div>

                <div class="form-group">
                  <label class="form-label">æ¬¡æ•¸ (reps) *</label>
                  <input type="number" id="reps-input" class="form-input" placeholder="ä¾‹å¦‚ï¼š10" min="1" max="100" required>
                </div>

                <div class="form-group">
                  <label class="form-label">çµ„æ•¸ (sets) *</label>
                  <input type="number" id="sets-input" class="form-input" placeholder="ä¾‹å¦‚ï¼š3" min="1" max="20" required>
                </div>

                <div class="form-group">
                  <label class="form-label">å‚™è¨»ï¼ˆé¸å¡«ï¼‰</label>
                  <textarea id="notes-input" class="form-textarea" rows="3" placeholder="è¨˜éŒ„ä»Šå¤©çš„æ„Ÿå—ã€æ³¨æ„äº‹é …ç­‰..."></textarea>
                </div>

                <button type="submit" class="btn btn-primary" style="width: 100%;">âœ… é€å‡ºè¨˜éŒ„</button>
              </form>

              <div class="card mt-3" style="background: #e3f7f6;">
                <div style="font-weight: bold; margin-bottom: 0.5rem;">ğŸ§® 1RM è¨ˆç®—å™¨</div>
                <div style="font-size: 0.9rem; color: #666;">
                  è¼¸å…¥é‡é‡å’Œæ¬¡æ•¸å¾Œï¼Œå³æ™‚è¨ˆç®—é ä¼° 1RM
                </div>
                <div id="1rm-display" style="margin-top: 0.5rem; font-size: 1.5rem; color: var(--primary-color); font-weight: bold;">
                  -- kg
                </div>
              </div>
            </div>
          </div>
        </div>

        <div>
          <div class="card">
            <div class="card-header">ğŸ“… ä»Šæ—¥è¨˜éŒ„</div>
            <div class="card-body">
              <div id="today-logs"><p class="text-center" style="color: #999; padding: 2rem;">è¼‰å…¥ä¸­...</p></div>
            </div>
          </div>
        </div>
      </div>

      <div class="card mt-4">
        <div class="card-header">ğŸ† å€‹äººæœ€ä½³è¨˜éŒ„ (PR)</div>
        <div class="card-body">
          <div id="pr-logs"><p class="text-center" style="color: #999;">è¼‰å…¥ä¸­...</p></div>
        </div>
      </div>

      <div class="card mt-4">
        <div class="card-header" style="display: flex; justify-content: space-between; align-items: center;">
          <span>ğŸ“œ æ­·å²è¨˜éŒ„</span>
          <div>
            <input type="date" id="date-filter" class="form-input" style="display: inline-block; width: auto;">
            <button id="view-stats-btn" class="btn btn-outline">ğŸ“Š æŸ¥çœ‹çµ±è¨ˆ</button>
          </div>
        </div>
        <div class="card-body">
          <div id="history-logs"><p class="text-center" style="color: #999;">é¸æ“‡æ—¥æœŸæŸ¥çœ‹è¨˜éŒ„</p></div>
        </div>
      </div>
    </div>
  </main>

  <!-- ç·¨è¼¯è¨˜éŒ„ Modal -->
  <div id="edit-modal" class="modal" style="display: none;">
    <div class="modal-content">
      <div class="modal-header">
        <h3>âœï¸ ç·¨è¼¯è¨˜éŒ„</h3>
        <button class="modal-close" onclick="closeEditModal()">Ã—</button>
      </div>
      <div class="modal-body">
        <form id="edit-form">
          <input type="hidden" id="edit-log-id">
          
          <div class="form-group">
            <label class="form-label">å‹•ä½œ</label>
            <input type="text" id="edit-exercise-name" class="form-input" disabled>
          </div>

          <div class="form-group">
            <label class="form-label">é‡é‡ (kg) *</label>
            <input type="number" id="edit-weight" class="form-input" min="0" max="500" step="0.5" required>
          </div>

          <div class="form-group">
            <label class="form-label">æ¬¡æ•¸ *</label>
            <input type="number" id="edit-reps" class="form-input" min="1" max="100" required>
          </div>

          <div class="form-group">
            <label class="form-label">çµ„æ•¸ *</label>
            <input type="number" id="edit-sets" class="form-input" min="1" max="20" required>
          </div>

          <div class="form-group">
            <label class="form-label">å‚™è¨»</label>
            <textarea id="edit-notes" class="form-textarea" rows="3"></textarea>
          </div>

          <div style="display: flex; gap: 0.5rem;">
            <button type="submit" class="btn btn-primary" style="flex: 1;">ğŸ’¾ å„²å­˜</button>
            <button type="button" class="btn btn-outline" onclick="closeEditModal()" style="flex: 1;">å–æ¶ˆ</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <script src="../js/api.js"></script>
  <script src="../js/auth-api.js"></script>
  <script>
    let allExercises = [];

    document.addEventListener('DOMContentLoaded', async () => {
      // ğŸ†• æª¢æŸ¥ç™»å…¥ç‹€æ…‹
      const isAuth = await requireAuth();
      if (!isAuth) return;
      
      // ğŸ†• æ›´æ–°å°èˆªåˆ—
      updateNavbarUser();
      
      await loadExercises();
      await loadTodayLogs();
      await loadPRLogs();
      setupFormValidation();
      setupDateFilter();
      setup1RMCalculator();
      setupEditForm();
      
      const urlParams = new URLSearchParams(window.location.search);
      const exerciseId = urlParams.get('exerciseId');
      if (exerciseId) {
        document.getElementById('exercise-select').value = exerciseId;
      }
      
      document.getElementById('view-stats-btn').addEventListener('click', () => {
        window.location.href = 'statistics.html';
      });
    });

    async function loadExercises() {
      allExercises = await fetchExercises();
      const select = document.getElementById('exercise-select');
      
      allExercises.forEach(exercise => {
        const option = document.createElement('option');
        option.value = exercise._id;
        // ğŸ†• ä½¿ç”¨ textContent é˜² XSS
        option.textContent = `${exercise.name} (${exercise.targetMuscle})`;
        select.appendChild(option);
      });
    }

    async function loadTodayLogs() {
      const today = formatDate(new Date(), 'ISO');
      const logs = await fetchLogsByDate(today);
      renderTodayLogs(logs);
    }

    async function loadPRLogs() {
      const prLogs = await fetchPRLogs();
      renderPRLogs(prLogs);
    }

    function renderPRLogs(logs) {
      const container = document.getElementById('pr-logs');
      
      if (logs.length === 0) {
        container.innerHTML = '<p class="text-center" style="color: #999; padding: 2rem;">é‚„æ²’æœ‰ PR è¨˜éŒ„ï¼Œç¹¼çºŒåŠªåŠ›ï¼ğŸ’ª</p>';
        return;
      }
      
      container.innerHTML = '';
      logs.forEach(log => {
        const prCard = document.createElement('div');
        prCard.style.cssText = 'padding: 1rem; margin-bottom: 0.5rem; background: #fff3cd; border-radius: var(--radius-md); border-left: 4px solid #ffc107;';
        
        const exerciseName = document.createElement('h4');
        exerciseName.textContent = `ğŸ† ${log.exerciseId.name}`;
        exerciseName.style.margin = '0 0 0.5rem 0';
        
        prCard.appendChild(exerciseName);
        
        const detailsDiv = document.createElement('div');
        detailsDiv.style.display = 'flex';
        detailsDiv.style.gap = '0.5rem';
        detailsDiv.innerHTML = `
          <span class="tag tag-warning">ğŸ’ª ${log.weight} kg</span>
          <span class="tag tag-success">ğŸ”¢ ${log.sets} çµ„ Ã— ${log.reps} æ¬¡</span>
          <span class="tag tag-info">ğŸ“Š 1RM: ${log.estimated1RM} kg</span>
        `;
        prCard.appendChild(detailsDiv);
        
        const dateSmall = document.createElement('small');
        dateSmall.textContent = `é”æˆæ—¥æœŸ: ${formatDate(log.date)}`;
        dateSmall.style.color = '#666';
        prCard.appendChild(dateSmall);
        
        container.appendChild(prCard);
      });
    }

    function renderTodayLogs(logs) {
      const container = document.getElementById('today-logs');
      
      if (logs.length === 0) {
        container.innerHTML = '<p class="text-center" style="color: #999; padding: 2rem;">ä»Šå¤©é‚„æ²’æœ‰è¨˜éŒ„<br><span style="font-size: 0.9rem;">é–‹å§‹ä½ çš„ç¬¬ä¸€æ¬¡è¨“ç·´å§ï¼ğŸ’ª</span></p>';
        return;
      }
      
      container.innerHTML = '';
      logs.forEach(log => {
        const logCard = createLogCard(log, true);
        container.appendChild(logCard);
      });
    }

    function createLogCard(log, showActions = false) {
      const card = document.createElement('div');
      card.className = 'log-card';
      card.style.cssText = 'padding: 1rem; margin-bottom: 0.5rem; background: #f8f9fa; border-radius: var(--radius-md); border-left: 4px solid var(--primary-color);';
      
      const exerciseName = log.exerciseId?.name || 'å·²åˆªé™¤å‹•ä½œ';
      const time = formatDate(log.date, 'time');
      const prBadge = log.isPR ? '<span class="tag tag-warning">ğŸ† PR</span>' : '';
      const editedBadge = log.isEdited ? '<small style="color: #999;">(å·²ç·¨è¼¯)</small>' : '';
      
      const titleDiv = document.createElement('div');
      titleDiv.style.display = 'flex';
      titleDiv.style.justifyContent = 'space-between';
      titleDiv.style.alignItems = 'start';
      
      const contentDiv = document.createElement('div');
      contentDiv.style.flex = '1';
      
      const nameH4 = document.createElement('h4');
      nameH4.style.margin = '0 0 0.5rem 0';
      nameH4.textContent = exerciseName + ' ';
      nameH4.innerHTML += prBadge + ' ' + editedBadge;
      contentDiv.appendChild(nameH4);
      
      const tagsDiv = document.createElement('div');
      tagsDiv.style.display = 'flex';
      tagsDiv.style.gap = '0.5rem';
      tagsDiv.style.flexWrap = 'wrap';
      tagsDiv.innerHTML = `
        <span class="tag tag-primary">ğŸ’ª ${log.weight} kg</span>
        <span class="tag tag-success">ğŸ”¢ ${log.sets} çµ„ Ã— ${log.reps} æ¬¡</span>
        <span class="tag tag-info">ğŸ“Š Volume: ${log.volume || (log.weight * log.reps * log.sets)}</span>
        <span class="tag tag-secondary">ğŸ¯ 1RM: ${log.estimated1RM || calculateEpley1RM(log.weight, log.reps)} kg</span>
        <span class="tag tag-info">ğŸ• ${escapeHtml(time)}</span>
      `;
      contentDiv.appendChild(tagsDiv);
      
      if (log.notes) {
        const notesP = document.createElement('p');
        notesP.style.cssText = 'margin-top: 0.5rem; color: #666; font-size: 0.9rem;';
        notesP.textContent = `ğŸ“ ${log.notes}`;
        contentDiv.appendChild(notesP);
      }
      
      titleDiv.appendChild(contentDiv);
      
      if (showActions) {
        const actionsDiv = document.createElement('div');
        actionsDiv.style.display = 'flex';
        actionsDiv.style.gap = '0.5rem';
        
        const editBtn = document.createElement('button');
        editBtn.className = 'btn btn-outline';
        editBtn.style.padding = '0.5rem';
        editBtn.textContent = 'ç·¨è¼¯';
        editBtn.onclick = () => openEditModal(log._id, log);
        
        const deleteBtn = document.createElement('button');
        deleteBtn.className = 'btn btn-danger';
        deleteBtn.style.padding = '0.5rem';
        deleteBtn.textContent = 'åˆªé™¤';
        deleteBtn.onclick = () => deleteLogRecord(log._id);
        
        actionsDiv.appendChild(editBtn);
        actionsDiv.appendChild(deleteBtn);
        titleDiv.appendChild(actionsDiv);
      }
      
      card.appendChild(titleDiv);
      return card;
    }

    function setup1RMCalculator() {
      const weightInput = document.getElementById('weight-input');
      const repsInput = document.getElementById('reps-input');
      const display = document.getElementById('1rm-display');
      
      function updateCalculator() {
        const weight = parseFloat(weightInput.value);
        const reps = parseInt(repsInput.value);
        
        if (weight > 0 && reps > 0) {
          const oneRM = calculateEpley1RM(weight, reps);
          display.textContent = `${oneRM} kg`;
          display.style.color = 'var(--primary-color)';
        } else {
          display.textContent = '-- kg';
          display.style.color = '#999';
        }
      }
      
      weightInput.addEventListener('input', updateCalculator);
      repsInput.addEventListener('input', updateCalculator);
    }

    function openEditModal(logId, log) {
      document.getElementById('edit-log-id').value = logId;
      document.getElementById('edit-exercise-name').value = log.exerciseId.name;
      document.getElementById('edit-weight').value = log.weight;
      document.getElementById('edit-reps').value = log.reps;
      document.getElementById('edit-sets').value = log.sets;
      document.getElementById('edit-notes').value = log.notes || '';
      
      document.getElementById('edit-modal').style.display = 'flex';
    }

    function closeEditModal() {
      document.getElementById('edit-modal').style.display = 'none';
      document.getElementById('edit-form').reset();
    }

    function setupEditForm() {
      document.getElementById('edit-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const logId = document.getElementById('edit-log-id').value;
        const weight = document.getElementById('edit-weight').value;
        const reps = document.getElementById('edit-reps').value;
        const sets = document.getElementById('edit-sets').value;
        const notes = document.getElementById('edit-notes').value;
        
        const result = await updateTrainingLog(logId, weight, reps, sets, notes);
        
        if (result) {
          closeEditModal();
          await loadTodayLogs();
          await loadPRLogs();
          
          const dateFilter = document.getElementById('date-filter');
          if (dateFilter.value) {
            const logs = await fetchLogsByDate(dateFilter.value);
            renderHistoryLogs(logs);
          }
        }
      });
    }

    function setupFormValidation() {
      const form = document.getElementById('log-form');
      
      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const exerciseId = document.getElementById('exercise-select').value;
        const weight = document.getElementById('weight-input').value;
        const reps = document.getElementById('reps-input').value;
        const sets = document.getElementById('sets-input').value;
        const notes = document.getElementById('notes-input').value;
        
        const result = await createTrainingLog(exerciseId, weight, reps, sets, notes);
        
        if (result) {
          form.reset();
          document.getElementById('1rm-display').textContent = '-- kg';
          await loadTodayLogs();
          await loadPRLogs();
        }
      });
    }

    function setupDateFilter() {
      const dateFilter = document.getElementById('date-filter');
      dateFilter.value = formatDate(new Date(), 'ISO');
      
      dateFilter.addEventListener('change', async (e) => {
        const logs = await fetchLogsByDate(e.target.value);
        renderHistoryLogs(logs);
      });
    }

    function renderHistoryLogs(logs) {
      const container = document.getElementById('history-logs');
      
      if (logs.length === 0) {
        container.innerHTML = '<p class="text-center" style="color: #999; padding: 2rem;">è©²æ—¥æœŸæ²’æœ‰è¨˜éŒ„</p>';
        return;
      }
      
      container.innerHTML = '';
      logs.forEach(log => {
        const logCard = createLogCard(log, true);
        container.appendChild(logCard);
      });
    }

    async function deleteLogRecord(logId) {
      if (!confirm('ç¢ºå®šè¦åˆªé™¤é€™ç­†è¨˜éŒ„å—ï¼Ÿ')) return;
      
      const result = await deleteLog(logId);
      if (result) {
        await loadTodayLogs();
        await loadPRLogs();
        
        const dateFilter = document.getElementById('date-filter');
        if (dateFilter.value) {
          const logs = await fetchLogsByDate(dateFilter.value);
          renderHistoryLogs(logs);
        }
      }
    }
  </script>

  <style>
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 10000;
    }
    
    .modal-content {
      background: white;
      border-radius: var(--radius-lg);
      max-width: 500px;
      width: 90%;
      max-height: 90vh;
      overflow-y: auto;
    }
    
    .modal-header {
      padding: 1.5rem;
      border-bottom: 2px solid var(--border-color);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .modal-header h3 {
      margin: 0;
    }
    
    .modal-close {
      background: none;
      border: none;
      font-size: 2rem;
      cursor: pointer;
      color: #999;
      line-height: 1;
    }
    
    .modal-close:hover {
      color: var(--error-color);
    }
    
    .modal-body {
      padding: 1.5rem;
    }
  </style>
</body>
</html>