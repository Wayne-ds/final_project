<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>çµ±è¨ˆåˆ†æ - FitMotion</title>
  <link rel="stylesheet" href="../css/style.css">
  <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
</head>
<body>
  <nav class="navbar">
    <div class="container">
      <a href="../index.html" class="navbar-brand">ğŸ’ª FitMotion</a>
      <ul class="navbar-nav">
        <li><a href="../index.html" class="nav-link">é¦–é </a></li>
        <li><a href="exercise-library.html" class="nav-link">å‹•ä½œè³‡æ–™åº«</a></li>
        <li><a href="workout-plan.html" class="nav-link">è¨“ç·´è¨ˆç•«</a></li>
        <li><a href="training-log.html" class="nav-link">è¨“ç·´è¨˜éŒ„</a></li>
        <li><a href="statistics.html" class="nav-link active">çµ±è¨ˆåˆ†æ</a></li>
      </ul>
    </div>
  </nav>

  <main class="main-content">
    <div class="container">
      <h1 class="mb-3">ğŸ“Š çµ±è¨ˆåˆ†æ</h1>

      <div class="grid grid-4 mb-4">
        <div class="card text-center">
          <div style="font-size: 2.5rem; color: var(--primary-color);" id="total-logs">0</div>
          <div style="color: #666; margin-top: 0.5rem;">ç¸½è¨“ç·´æ¬¡æ•¸</div>
        </div>
        <div class="card text-center">
          <div style="font-size: 2.5rem; color: var(--secondary-color);" id="total-exercises">0</div>
          <div style="color: #666; margin-top: 0.5rem;">è¨“ç·´å‹•ä½œæ•¸</div>
        </div>
        <div class="card text-center">
          <div style="font-size: 2.5rem; color: var(--accent-color);" id="this-month">0</div>
          <div style="color: #666; margin-top: 0.5rem;">æœ¬æœˆè¨“ç·´å¤©æ•¸</div>
        </div>
        <div class="card text-center">
          <div style="font-size: 2.5rem; color: var(--success-color);" id="streak-days">0</div>
          <div style="color: #666; margin-top: 0.5rem;">é€£çºŒè¨“ç·´å¤©æ•¸</div>
        </div>
      </div>

      <div class="grid grid-2 mb-4">
        <div class="card">
          <div class="card-header">ğŸ¯ å„éƒ¨ä½è¨“ç·´åˆ†å¸ƒ</div>
          <div class="card-body">
            <div id="muscle-chart" style="width: 100%; height: 400px;">
              <p class="text-center" style="padding: 3rem; color: #999;">è¼‰å…¥ä¸­...</p>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="card-header">ğŸ“… æ¯æœˆè¨“ç·´é »ç‡</div>
          <div class="card-body">
            <div id="frequency-chart" style="width: 100%; height: 400px;">
              <p class="text-center" style="padding: 3rem; color: #999;">è¼‰å…¥ä¸­...</p>
            </div>
          </div>
        </div>
      </div>

      <div class="card mb-4">
        <div class="card-header" style="display: flex; justify-content: space-between; align-items: center;">
          <span>ğŸ“ˆ é‡é‡é€²æ­¥æ›²ç·š</span>
          <select id="exercise-selector" class="form-select" style="width: auto; display: inline-block;">
            <option value="">-- é¸æ“‡å‹•ä½œ --</option>
          </select>
        </div>
        <div class="card-body">
          <div id="progress-chart" style="width: 100%; height: 400px;">
            <p class="text-center" style="padding: 3rem; color: #999;">è«‹é¸æ“‡å‹•ä½œæŸ¥çœ‹é€²æ­¥æ›²ç·š</p>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="card-header">ğŸ“‹ æœ€è¿‘ 10 ç­†è¨“ç·´è¨˜éŒ„</div>
        <div class="card-body">
          <div id="recent-logs-table" style="overflow-x: auto;"></div>
        </div>
      </div>
    </div>
  </main>

  <script src="../js/api.js"></script>
  <script src="../js/auth-api.js"></script>
  <script>
    let allLogs = [];
    let allExercises = [];

    google.charts.load('current', {'packages':['corechart']});
    google.charts.setOnLoadCallback(initPage);

    async function initPage() {
      // ğŸ†• æª¢æŸ¥ç™»å…¥ç‹€æ…‹
      const isAuth = await requireAuth();
      if (!isAuth) return;
      
      // ğŸ†• æ›´æ–°å°èˆªåˆ—
      updateNavbarUser();
      
      await loadData();
      updateStatistics();
      drawMuscleChart();
      drawFrequencyChart();
      setupExerciseSelector();
      renderRecentLogsTable();
    }

    async function loadData() {
      allLogs = await fetchAllLogs();
      allExercises = await fetchExercises();
    }

    function updateStatistics() {
      document.getElementById('total-logs').textContent = allLogs.length;

      const uniqueExercises = new Set(
        allLogs
          .filter(log => log.exerciseId)
          .map(log => log.exerciseId._id)
      );
      document.getElementById('total-exercises').textContent = uniqueExercises.size;

      const now = new Date();
      const firstDayOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
      const thisMonthLogs = allLogs.filter(log => new Date(log.date) >= firstDayOfMonth);
      const uniqueDaysThisMonth = new Set(
        thisMonthLogs.map(log => new Date(log.date).toDateString())
      );
      document.getElementById('this-month').textContent = uniqueDaysThisMonth.size;

      const streak = calculateStreak();
      document.getElementById('streak-days').textContent = streak;
    }

    function calculateStreak() {
      if (allLogs.length === 0) return 0;

      const uniqueDates = [...new Set(
        allLogs.map(log => new Date(log.date).toDateString())
      )].sort((a, b) => new Date(b) - new Date(a));

      let streak = 0;
      
      for (let i = 0; i < uniqueDates.length; i++) {
        const checkDate = new Date();
        checkDate.setDate(checkDate.getDate() - i);
        
        if (uniqueDates[i] === checkDate.toDateString()) {
          streak++;
        } else {
          break;
        }
      }

      return streak;
    }

    function drawMuscleChart() {
      if (allLogs.length === 0) {
        document.getElementById('muscle-chart').innerHTML = 
          '<p class="text-center" style="padding: 3rem; color: #999;">é‚„æ²’æœ‰è¨“ç·´è¨˜éŒ„</p>';
        return;
      }

      const muscleCount = {};
      allLogs.forEach(log => {
        if (log.exerciseId && log.exerciseId.targetMuscle) {
          const muscle = log.exerciseId.targetMuscle;
          muscleCount[muscle] = (muscleCount[muscle] || 0) + 1;
        }
      });

      const chartData = [['éƒ¨ä½', 'è¨“ç·´æ¬¡æ•¸']];
      Object.entries(muscleCount).forEach(([muscle, count]) => {
        chartData.push([muscle, count]);
      });

      const data = google.visualization.arrayToDataTable(chartData);

      const options = {
        title: 'å„éƒ¨ä½è¨“ç·´åˆ†å¸ƒ',
        pieHole: 0.4,
        colors: ['#FF6B6B', '#4ECDC4', '#45B7D1', '#FFA07A', '#98D8C8', '#F7DC6F'],
        legend: { position: 'bottom' },
        chartArea: { width: '90%', height: '70%' },
        pieSliceText: 'percentage',
        tooltip: { text: 'both' }
      };

      const chart = new google.visualization.PieChart(
        document.getElementById('muscle-chart')
      );
      chart.draw(data, options);
    }

    function drawFrequencyChart() {
      if (allLogs.length === 0) {
        document.getElementById('frequency-chart').innerHTML = 
          '<p class="text-center" style="padding: 3rem; color: #999;">é‚„æ²’æœ‰è¨“ç·´è¨˜éŒ„</p>';
        return;
      }

      const monthlyDays = {};
      const uniqueDatesByMonth = {};

      allLogs.forEach(log => {
        const date = new Date(log.date);
        const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
        const dateKey = date.toDateString();

        if (!uniqueDatesByMonth[monthKey]) {
          uniqueDatesByMonth[monthKey] = new Set();
        }
        uniqueDatesByMonth[monthKey].add(dateKey);
      });

      Object.entries(uniqueDatesByMonth).forEach(([month, dates]) => {
        monthlyDays[month] = dates.size;
      });

      const sortedMonths = Object.keys(monthlyDays).sort().slice(-6);
      
      const chartData = [['æœˆä»½', 'è¨“ç·´å¤©æ•¸', { role: 'style' }]];
      sortedMonths.forEach(month => {
        const days = monthlyDays[month];
        const color = days >= 15 ? '#4ECDC4' : '#FF6B6B';
        chartData.push([month, days, color]);
      });

      const data = google.visualization.arrayToDataTable(chartData);

      const options = {
        title: 'æ¯æœˆè¨“ç·´é »ç‡',
        vAxis: {
          title: 'è¨“ç·´å¤©æ•¸',
          minValue: 0,
          gridlines: { color: '#f0f0f0' }
        },
        hAxis: {
          title: 'æœˆä»½'
        },
        legend: { position: 'none' },
        chartArea: { width: '80%', height: '70%' },
        bar: { groupWidth: '70%' }
      };

      const chart = new google.visualization.ColumnChart(
        document.getElementById('frequency-chart')
      );
      chart.draw(data, options);
    }

    function setupExerciseSelector() {
      const selector = document.getElementById('exercise-selector');
      
      const exercisesWithLogs = new Set(
        allLogs
          .filter(log => log.exerciseId)
          .map(log => log.exerciseId._id)
      );

      allExercises
        .filter(ex => exercisesWithLogs.has(ex._id))
        .forEach(exercise => {
          const option = document.createElement('option');
          option.value = exercise._id;
          option.textContent = exercise.name;
          selector.appendChild(option);
        });

      selector.addEventListener('change', (e) => {
        if (e.target.value) {
          drawProgressChart(e.target.value);
        } else {
          document.getElementById('progress-chart').innerHTML = 
            '<p class="text-center" style="padding: 3rem; color: #999;">è«‹é¸æ“‡å‹•ä½œæŸ¥çœ‹é€²æ­¥æ›²ç·š</p>';
        }
      });
    }

    function drawProgressChart(exerciseId) {
      const exerciseLogs = allLogs
        .filter(log => log.exerciseId && log.exerciseId._id === exerciseId)
        .sort((a, b) => new Date(a.date) - new Date(b.date));

      if (exerciseLogs.length === 0) {
        document.getElementById('progress-chart').innerHTML = 
          '<p class="text-center" style="padding: 3rem; color: #999;">è©²å‹•ä½œé‚„æ²’æœ‰è¨“ç·´è¨˜éŒ„</p>';
        return;
      }

      const data = new google.visualization.DataTable();
      data.addColumn('date', 'æ—¥æœŸ');
      data.addColumn('number', 'é‡é‡ (kg)');
      data.addColumn({ type: 'string', role: 'tooltip' });

      exerciseLogs.forEach(log => {
        const date = new Date(log.date);
        const tooltip = `${formatDate(date)}\né‡é‡: ${log.weight}kg\n${log.sets}çµ„ Ã— ${log.reps}æ¬¡`;
        data.addRow([date, log.weight, tooltip]);
      });

      const options = {
        title: `${exerciseLogs[0].exerciseId.name} - é‡é‡é€²æ­¥æ›²ç·š`,
        curveType: 'function',
        legend: { position: 'bottom' },
        hAxis: {
          title: 'æ—¥æœŸ',
          format: 'MM/dd',
          gridlines: { color: '#f0f0f0' }
        },
        vAxis: {
          title: 'é‡é‡ (kg)',
          minValue: 0,
          gridlines: { color: '#f0f0f0' }
        },
        colors: ['#FF6B6B'],
        pointSize: 6,
        lineWidth: 3,
        chartArea: { width: '85%', height: '70%' },
        trendlines: { 
          0: { 
            type: 'linear',
            color: '#4ECDC4',
            lineWidth: 2,
            opacity: 0.5,
            showR2: true,
            visibleInLegend: true
          } 
        }
      };

      const chart = new google.visualization.LineChart(
        document.getElementById('progress-chart')
      );
      chart.draw(data, options);
    }

    function renderRecentLogsTable() {
      const container = document.getElementById('recent-logs-table');
      
      if (allLogs.length === 0) {
        container.innerHTML = '<p class="text-center" style="padding: 2rem; color: #999;">é‚„æ²’æœ‰è¨“ç·´è¨˜éŒ„</p>';
        return;
      }

      const recentLogs = allLogs.slice(0, 10);

      const table = document.createElement('table');
      table.style.cssText = 'width: 100%; border-collapse: collapse;';
      
      const thead = document.createElement('thead');
      thead.innerHTML = `
        <tr style="background: #f8f9fa; text-align: left;">
          <th style="padding: 0.75rem; border-bottom: 2px solid #dee2e6;">æ—¥æœŸ</th>
          <th style="padding: 0.75rem; border-bottom: 2px solid #dee2e6;">å‹•ä½œ</th>
          <th style="padding: 0.75rem; border-bottom: 2px solid #dee2e6;">éƒ¨ä½</th>
          <th style="padding: 0.75rem; border-bottom: 2px solid #dee2e6;">é‡é‡</th>
          <th style="padding: 0.75rem; border-bottom: 2px solid #dee2e6;">çµ„æ•¸Ã—æ¬¡æ•¸</th>
        </tr>
      `;
      table.appendChild(thead);
      
      const tbody = document.createElement('tbody');
      recentLogs.forEach(log => {
        const date = formatDate(log.date);
        const exercise = log.exerciseId ? log.exerciseId.name : 'æœªçŸ¥';
        const muscle = log.exerciseId ? log.exerciseId.targetMuscle : '-';
        
        const tr = document.createElement('tr');
        tr.style.borderBottom = '1px solid #dee2e6';
        
        const tdDate = document.createElement('td');
        tdDate.style.padding = '0.75rem';
        tdDate.textContent = date;
        
        const tdExercise = document.createElement('td');
        tdExercise.style.cssText = 'padding: 0.75rem; font-weight: bold;';
        tdExercise.textContent = exercise;
        
        const tdMuscle = document.createElement('td');
        tdMuscle.style.padding = '0.75rem';
        tdMuscle.innerHTML = `<span class="tag tag-primary">${escapeHtml(muscle)}</span>`;
        
        const tdWeight = document.createElement('td');
        tdWeight.style.padding = '0.75rem';
        tdWeight.textContent = `${log.weight} kg`;
        
        const tdSetsReps = document.createElement('td');
        tdSetsReps.style.padding = '0.75rem';
        tdSetsReps.textContent = `${log.sets} Ã— ${log.reps}`;
        
        tr.appendChild(tdDate);
        tr.appendChild(tdExercise);
        tr.appendChild(tdMuscle);
        tr.appendChild(tdWeight);
        tr.appendChild(tdSetsReps);
        
        tbody.appendChild(tr);
      });
      table.appendChild(tbody);
      
      container.innerHTML = '';
      container.appendChild(table);
    }
    function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}
  </script>
</body>
</html>